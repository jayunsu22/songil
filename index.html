<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>AI 인테리어 견적 채팅</title><script src="https://www.google.com/search?q=https://cdn.tailwindcss.com"></script><style>@import url('https://www.google.com/search?q=https://fonts.googleapis.com/css2%3Ffamily%3DInter:wght%40400%3B600%3B700%26display%3Dswap');body {font-family: 'Inter', sans-serif;background-color: #f7f9fb;display: flex;justify-content: center;align-items: center;min-height: 100vh;padding: 20px;}.chat-container {width: 100%;max-width: 480px;height: 80vh;max-height: 700px;background: white;border-radius: 16px;box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);display: flex;flex-direction: column;overflow: hidden;}.chat-header {padding: 1rem;background-color: #3b82f6; /* Blue 500 /color: white;font-weight: 700;text-align: center;border-top-left-radius: 16px;border-top-right-radius: 16px;}#chat-box {flex-grow: 1;padding: 1rem;overflow-y: auto;background-color: #eef2f6; / Gray 100 /display: flex;flex-direction: column;gap: 12px;}.message {max-width: 85%;padding: 10px 15px;border-radius: 18px;line-height: 1.5;word-wrap: break-word;}.user {align-self: flex-end;background-color: #4f46e5; / Indigo 600 /color: white;border-bottom-right-radius: 4px;}.bot {align-self: flex-start;background-color: #ffffff;color: #1f2937; / Gray 800 /box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);border: 1px solid #d1d5db; / Gray 300 */border-bottom-left-radius: 4px;}.input-area {display: flex;padding: 1rem;background-color: #ffffff;border-top: 1px solid #e5e7eb;}#user-input {flex-grow: 1;padding: 10px;border: 2px solid #e5e7eb;border-radius: 10px;margin-right: 10px;transition: border-color 0.2s;}#user-input:focus {outline: none;border-color: #3b82f6;}#send-button {padding: 10px 15px;background-color: #3b82f6;color: white;border-radius: 10px;font-weight: 600;transition: background-color 0.2s, transform 0.1s;}#send-button:hover:not(:disabled) {background-color: #2563eb;}#send-button:disabled {background-color: #93c5fd;cursor: not-allowed;}.loading-indicator {display: inline-block;width: 10px;height: 10px;border: 2px solid rgba(255, 255, 255, 0.3);border-radius: 50%;border-top-color: #fff;animation: spin 1s ease-in-out infinite;}@keyframes spin {to { transform: rotate(360deg); }}</style></head><body><div class="chat-container"><div class="chat-header">AI 인테리어 견적 챗봇</div><div id="chat-box"><!-- 초기 메시지 --><div class="message bot">안녕하세요! 인테리어 시공 견적을 도와드릴 AI 챗봇입니다.예시처럼 필요한 항목과 수량을 입력해주세요.예시: 방문 3개, 샤시 5개 견적 알려줘</div></div><div class="input-area"><input type="text" id="user-input" placeholder="견적 요청 사항을 입력하세요"><button id="send-button">전송</button></div></div><script>// ** 고객님의 N8N Webhook URL로 반드시 변경해야 합니다. **const N8N_WEBHOOK_URL = "https://primary-production-a6fa.up.railway.app/webhook/landbot-request";const chatBox = document.getElementById(&#39;chat-box&#39;);
const userInput = document.getElementById(&#39;user-input&#39;);
const sendButton = document.getElementById(&#39;send-button&#39;);

// ----------------------------------------------------
// [핵심 수정 함수 1] 메시지 추가 함수 (HTML 렌더링 기능 추가)
// ----------------------------------------------------
function appendMessage(message, sender, isHtml = false) {
    const messageElement = document.createElement(&#39;div&#39;);
    messageElement.classList.add(&#39;message&#39;, sender);
    
    // n8n에서 <br> 태그가 포함된 응답을 받기 때문에 innerHTML을 사용해야 합니다.
    if (isHtml) {
        messageElement.innerHTML = message;
    } else {
        messageElement.textContent = message;
    }
    
    chatBox.appendChild(messageElement);
    chatBox.scrollTop = chatBox.scrollHeight;
}

// ----------------------------------------------------
// [보조 함수] 오류 발생 시 재시도 로직
// ----------------------------------------------------
async function fetchWithRetry(url, options, retries = 3) {
    for (let i = 0; i &lt; retries; i++) {
        try {
            const response = await fetch(url, options);
            if (response.ok) {
                return response;
            }
            // 4xx, 5xx 에러는 재시도하지 않고 바로 오류 발생
            throw new Error(`Server responded with status: ${response.status}`);
        } catch (error) {
            if (i === retries - 1) throw error; 
            await new Promise(resolve =&gt; setTimeout(resolve, 1000 * (i + 1))); // 지수 백오프
        }
    }
}

// ----------------------------------------------------
// [핵심 수정 함수 2] N8N으로 메시지 전송 및 응답 처리
// ----------------------------------------------------
async function sendMessageToN8n(message) {
    if (!message.trim()) return;

    // 사용자 메시지 출력
    appendMessage(message, &#39;user&#39;);
    
    userInput.value = &#39;&#39;;
    sendButton.disabled = true;

    // 로딩 메시지 출력
    const loadingMessage = document.createElement(&#39;div&#39;);
    loadingMessage.classList.add(&#39;message&#39;, &#39;bot&#39;, &#39;flex&#39;, &#39;items-center&#39;, &#39;space-x-2&#39;);
    loadingMessage.innerHTML = &#39;&lt;span&gt;견적 계산 중...&lt;/span&gt;&lt;span class=&quot;loading-indicator&quot;&gt;&lt;/span&gt;&#39;;
    chatBox.appendChild(loadingMessage);
    chatBox.scrollTop = chatBox.scrollHeight;


    try {
        const options = {
            method: &#39;POST&#39;,
            headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },
            body: JSON.stringify({ user_request: message })
        };
        
        const response = await fetchWithRetry(N8N_WEBHOOK_URL, options);
        
        // ✅ 수정된 부분: N8N이 순수 텍스트(text/plain)를 반환하도록 설정했으므로, .text()로 받습니다.
        const resultText = await response.text(); 
        
        // 로딩 메시지 제거
        chatBox.removeChild(loadingMessage);

        // 봇 메시지 생성 및 출력
        // n8n에서 <br> 태그가 포함된 최종 견적 메시지가 resultText에 담겨 있습니다.
        appendMessage(resultText, &#39;bot&#39;, true); // true를 전달하여 HTML로 렌더링

    } catch (error) {
        console.error(&#39;N8N Webhook 호출 중 오류 발생:&#39;, error);
        // 로딩 메시지 제거 (오류 발생 시에도 제거)
        if (chatBox.contains(loadingMessage)) {
            chatBox.removeChild(loadingMessage);
        }
        appendMessage(&#39;죄송합니다. 견적을 계산하는 중 시스템 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.&#39;, &#39;bot&#39;);
    } finally {
        sendButton.disabled = false;
        userInput.focus();
    }
}

// ----------------------------------------------------
// 이벤트 리스너
// ----------------------------------------------------
sendButton.addEventListener(&#39;click&#39;, () =&gt; {
    sendMessageToN8n(userInput.value);
});

userInput.addEventListener(&#39;keydown&#39;, (event) =&gt; {
    if (event.key === &#39;Enter&#39; &amp;&amp; !sendButton.disabled) {
        sendMessageToN8n(userInput.value);
    }
});
</script></body></html>
