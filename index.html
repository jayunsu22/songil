<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ìë™ ê²¬ì  ì±„íŒ…</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .chat-container { max-width: 500px; margin: 40px auto; background-color: white; border-radius: 1.5rem; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); overflow: hidden; }
        .chat-header { background: linear-gradient(135deg, #6b46c1 0%, #a855f7 100%); color: white; padding: 1.5rem; text-align: center; }
        .chat-body { padding: 1.5rem; max-height: 50vh; overflow-y: auto; scroll-behavior: smooth; }
        .user-message { background-color: #e0e7ff; border-radius: 0.75rem 0.75rem 0.1rem 0.75rem; padding: 0.75rem 1rem; max-width: 80%; margin-left: auto; margin-bottom: 0.5rem; color: #1e3a8a; }
        .system-message { background-color: #f3f4f6; border-radius: 0.75rem 0.75rem 0.75rem 0.1rem; padding: 0.75rem 1rem; max-width: 80%; margin-right: auto; margin-bottom: 0.5rem; color: #1f2937; }
        .quote-result { background-color: #fffbeb; border: 1px solid #fcd34d; border-radius: 0.75rem; padding: 1rem; margin-top: 1rem; white-space: pre-wrap; }
        .option-panel { border-top: 1px solid #e5e7eb; padding: 1.5rem; }
        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 600; color: #4b5563; }
        input[type="number"], select, textarea { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; }
        button { transition: background-color 0.2s, transform 0.1s; }
        button:hover { transform: translateY(-1px); }
        button:active { transform: translateY(0); }
    </style>
</head>
<body>

    <div class="chat-container">
        <!-- Header -->
        <div class="chat-header">
            <h1 class="text-2xl font-bold">AI ê²¬ì  ìš”ì²­</h1>
            <p class="text-sm opacity-80 mt-1">AIê°€ ê³ ê°ë‹˜ì˜ ìš”ì²­ì„ ê²€í† í•˜ì—¬ ê²¬ì ì„ ë‚´ë“œë¦½ë‹ˆë‹¤.</p>
        </div>

        <!-- Chat Body (Message Display) -->
        <div id="chatBody" class="chat-body">
            <div class="system-message">ì•ˆë…•í•˜ì„¸ìš”! ì–´ë–¤ ì‹œê³µì´ í•„ìš”í•˜ì‹ ê°€ìš”? ì•„ë˜ í•­ëª©ì„ ì„ íƒí•˜ê±°ë‚˜, ì§ì ‘ ìš”ì²­ì‚¬í•­ì„ ì ì–´ì£¼ì„¸ìš”.</div>
        </div>

        <!-- Quote Input Panel -->
        <div class="option-panel">
            <div id="quoteForm">

                <!-- 1. í’ˆëª© ì„ íƒ (Dropdown) -->
                <div class="input-group">
                    <label for="itemSelect">í•„ìš” í’ˆëª©</label>
                    <select id="itemSelect" class="focus:ring-purple-500 focus:border-purple-500">
                        <option value="í™”ì¥ì‹¤ë¬¸">í™”ì¥ì‹¤ ë¬¸ ì‹œê³µ</option>
                        <option value="í˜„ê´€ë¬¸">í˜„ê´€ ë¬¸ ì‹œê³µ</option>
                        <option value="ë°©ë¬¸">ë°© ë¬¸ ì‹œê³µ</option>
                        <option option value="ê¸°íƒ€">ê¸°íƒ€ (ì•„ë˜ ìš”ì²­ì‚¬í•­ì— ìì„¸íˆ ê¸°ì¬)</option>
                    </select>
                </div>

                <!-- 2. ìˆ˜ëŸ‰ ì…ë ¥ -->
                <div class="input-group">
                    <label for="quantityInput">ìˆ˜ëŸ‰ (ê°œ)</label>
                    <input type="number" id="quantityInput" value="1" min="1" class="focus:ring-purple-500 focus:border-purple-500">
                </div>
                
                <!-- 3. ìƒì„¸ ìš”ì²­ ì‚¬í•­ (AI ê²€í† ìš©) -->
                <div class="input-group">
                    <label for="requestText">ìƒì„¸ ìš”ì²­ ì‚¬í•­ (AIê°€ ê²€í† )</label>
                    <textarea id="requestText" rows="3" placeholder="ì˜ˆ: í™”ìì‹œë¬¸ 2ê°œ, ë¬¸ì§ êµì²´, í°ìƒ‰ ì‹œíŠ¸ì§€" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500"></textarea>
                </div>

                <!-- 4. ê²¬ì  ìš”ì²­ ë²„íŠ¼ -->
                <button onclick="calculateQuote()" id="quoteButton"
                    class="w-full py-3 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 disabled:bg-purple-300 shadow-md">
                    AIì—ê²Œ ê²¬ì  ìš”ì²­í•˜ê¸°
                </button>
                <div id="loadingMessage" class="text-center text-sm text-gray-500 mt-2 hidden">ìš”ì²­ì„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤... (ìµœëŒ€ 10ì´ˆ ì†Œìš”)</div>
                <div id="errorMessage" class="text-center text-sm text-red-500 mt-2 hidden"></div>
            </div>
        </div>
    </div>

    <script>
        // =======================================================================
        // â˜…â˜…â˜… 1. n8n Webhook URL ì„¤ì • (ê³ ê°ë‹˜ê»˜ì„œ ì œê³µí•˜ì‹  URLë¡œ ì—…ë°ì´íŠ¸ë¨) â˜…â˜…â˜…
        // =======================================================================
        const N8N_WEBHOOK_URL = 'https://primary-production-a6fa.up.railway.app/webhook/landbot-request';

        // =======================================================================
        // 2. ê¸°íƒ€ ì„¤ì •
        // =======================================================================
        const chatBody = document.getElementById('chatBody');
        const quoteButton = document.getElementById('quoteButton');
        const loadingMessage = document.getElementById('loadingMessage');
        const errorMessage = document.getElementById('errorMessage');

        function appendMessage(text, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'user' ? 'user-message' : 'system-message';
            messageDiv.innerHTML = text.replace(/\n/g, '<br>');
            chatBody.appendChild(messageDiv);
            chatBody.scrollTop = chatBody.scrollHeight; // ìŠ¤í¬ë¡¤ í•˜ë‹¨ìœ¼ë¡œ ì´ë™
        }

        // ì§€ìˆ˜ ë°±ì˜¤í”„ë¥¼ ì‚¬ìš©í•œ fetch í•¨ìˆ˜
        async function fetchWithRetry(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < retries - 1) { // 429 Too Many Requests
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        console.log(`Rate limit exceeded. Retrying in ${Math.round(delay / 1000)}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP ì˜¤ë¥˜! ìƒíƒœ ì½”ë“œ: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === retries - 1) throw error;
                    // ê¸°íƒ€ ì˜¤ë¥˜ì— ëŒ€í•œ ì¬ì‹œë„ ë¡œì§ì€ ì—¬ê¸°ì—ì„œ ìƒëµí•˜ê±°ë‚˜ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                }
            }
        }


        async function calculateQuote() {
            const itemSelect = document.getElementById('itemSelect').value;
            const quantityInput = document.getElementById('quantityInput').value;
            const requestText = document.getElementById('requestText').value;

            // ì‚¬ìš©ì ì…ë ¥ ë©”ì‹œì§€ë¥¼ ì±„íŒ…ì°½ì— í‘œì‹œ
            const userMessageText = `í’ˆëª©: ${itemSelect}\nìˆ˜ëŸ‰: ${quantityInput}ê°œ\nìš”ì²­: ${requestText}`;
            appendMessage(userMessageText, 'user');
            
            // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
            quoteButton.disabled = true;
            loadingMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            
            // =======================================================================
            // â˜…â˜…â˜… 3. n8n Webhookìœ¼ë¡œ ë°ì´í„° ì „ì†¡ â˜…â˜…â˜…
            // =======================================================================
            try {
                const payload = {
                    // n8n Webhookì´ ë°›ì„ ë°ì´í„° í˜•ì‹
                    item_type: itemSelect,
                    quantity: parseInt(quantityInput, 10),
                    user_request: requestText,
                    // chat_idëŠ” Landbot ì—†ì´ ì„ì˜ë¡œ ìƒì„± (n8nì—ì„œ ì‚¬ìš©ë  ìˆ˜ ìˆìŒ)
                    chat_id: 'web-' + Date.now() 
                };

                const options = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                };

                const response = await fetchWithRetry(N8N_WEBHOOK_URL, options);

                // n8nì—ì„œ ë°˜í™˜ëœ ì‘ë‹µ (JSON í˜•ì‹, { message_to_send: "..." } í˜•íƒœ ê¸°ëŒ€)
                const result = await response.json();
                
                // n8nì´ ë°˜í™˜í•œ ë©”ì‹œì§€(ì´ ê²¬ì  ê²°ê³¼)ë¥¼ ì±„íŒ…ì°½ì— í‘œì‹œ
                // n8nì˜ "ì‘ë‹µë…¸ë“œ"ì—ì„œ ë°˜í™˜ëœ ìµœì¢… ë©”ì‹œì§€ í•„ë“œê°€ 'message_to_send'ë¼ê³  ê°€ì •í•©ë‹ˆë‹¤.
                const finalMessage = result.message_to_send || 
                                     `ğŸ“¢ AI ê²€í†  ë° ê²¬ì  ê³„ì‚° ì™„ë£Œ! <br><br>n8n ì›Œí¬í”Œë¡œìš°ëŠ” ì •ìƒ ì‘ë™í–ˆì§€ë§Œ, ì‘ë‹µ ë©”ì‹œì§€ í•„ë“œ(message_to_send)ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. <br>n8nì˜ **'ì›¹í›…ì‘ë‹µ'** ë…¸ë“œì—ì„œ **'message_to_send'** í•„ë“œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`;
                
                appendMessage(`<div class="quote-result">${finalMessage}</div>`, 'system');
                
            } catch (error) {
                console.error("n8n Webhook í˜¸ì¶œ ì˜¤ë¥˜:", error);
                const errorText = `âŒ ê²¬ì  ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}. <br>1. n8n ì›Œí¬í”Œë¡œìš°ê°€ **'Active' ìƒíƒœ**ì¸ì§€ í™•ì¸í•˜ì„¸ìš”. <br>2. **Webhook ë…¸ë“œì˜ ì„¤ì •**ì´ POST ë°©ì‹ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.`;
                errorMessage.textContent = errorText;
                errorMessage.classList.remove('hidden');
                appendMessage(errorText, 'system');
            } finally {
                // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™” ë° ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¹€
                quoteButton.disabled = false;
                loadingMessage.classList.add('hidden');
            }
        }

        // ì´ˆê¸° ë©”ì‹œì§€ ë° UI ë¡œë“œ ì‹œ ìŠ¤í¬ë¡¤ ì¡°ì •
        window.onload = () => {
            chatBody.scrollTop = chatBody.scrollHeight;
        };
    </script>
</body>
</html>
