// ìˆ˜ì •ì¼: 2025-11-20 14:00 (ì œëª© ë³€ê²½ ë° í•œêµ­ ì‹œê°„ í‘œì‹œ ì¶”ê°€)

const toNumber = v => Number.isFinite(Number(v)) ? Number(v) : 0;

const rawLines = [];
for (const it of items) {
    const j = it.json || {};
    const row = j.fields || j;

    let rawName = row.ìƒì„¸_í’ˆëª©ëª…?.[0] ?? row.í’ˆëª©ëª… ?? row.name ?? '';
    
    // [ì´ë¦„ ì •ë¦¬] 
    let cleanName = rawName.replace(/\(ê¸°ë³¸í‹€\)/g, '').replace(/\(ë¬¸ì§ì¶”ê°€\)/g, '').trim();
    const furnitureKeywords = ['ë¶™ë°•ì´ì¥', 'ì‹ ë°œì¥', 'ìˆ˜ë‚©ì¥', 'ëƒ‰ì¥ê³ ì¥', 'ì¤‘ë¬¸'];
    if (furnitureKeywords.some(kw => cleanName.startsWith(kw))) {
        cleanName = cleanName.replace(/í‹€$/, '').replace(/ë¬¸ì§$/, '').trim();
    }

    const qty = toNumber(row.ìƒì„¸_ìˆ˜ëŸ‰ ?? row.qty ?? 1);
    
    let unitRaw = row.ê²¬ì ë‹¨ìœ„;
    if (Array.isArray(unitRaw) && unitRaw.length > 0) {
        unitRaw = unitRaw[0]; 
    }
    const unit = unitRaw || 'ì„¸íŠ¸'; 

    let displayLabel = row.í‘œì‹œìˆ˜ëŸ‰;
    if (displayLabel === 'hide') {
        displayLabel = ''; 
    } else if (!displayLabel) {
        displayLabel = `${qty}${unit}`;
    }
    
    const material = toNumber(row.ìì¬ë¹„í•©ê³„ ?? 0);
    const labor = toNumber(row.ì¸ê±´ë¹„í•©ê³„ ?? 0);
    const subtotal = toNumber(row.ìƒì„¸_ë¼ì¸ê¸ˆì•¡ ?? 0);
    const itemText = row.í’ˆëª©ì„¤ëª…_ì €ì¥ || ''; 
    const commonText = row.ê³µí†µì„¤ëª…_ì €ì¥ || '';

    rawLines.push({ name: cleanName, qty, displayLabel, material, labor, subtotal, itemText, commonText });
}

const mergedMap = new Map();
let commonNotification = ""; 

for (const li of rawLines) {
    const key = li.name; 

    if (!mergedMap.has(key)) {
        mergedMap.set(key, { ...li });
    } else {
        const cur = mergedMap.get(key);
        cur.material += li.material;
        cur.labor += li.labor;
        cur.subtotal += li.subtotal;
        
        if (li.displayLabel && !cur.displayLabel) {
            cur.displayLabel = li.displayLabel;
        }
        
        if (li.itemText && !cur.itemText.includes(li.itemText)) {
             cur.itemText += '\n' + li.itemText;
        }
        mergedMap.set(key, cur);
    }

    if (!commonNotification && typeof li.commonText === 'string' && li.commonText.trim() !== '') {
        commonNotification = '~ ' + li.commonText.trim().replace(/\n/g, '<br>~ ');
    }
}

// [!] ì‹œê°„ ìƒì„± (í•œêµ­ ì‹œê°„)
const now = new Date();
const timeString = now.toLocaleString('ko-KR', { 
    timeZone: 'Asia/Seoul', 
    month: 'numeric', 
    day: 'numeric', 
    hour: '2-digit', 
    minute: '2-digit', 
    hour12: false 
}); 
// ì˜ˆ: "11. 20. 14:30" í˜•ì‹ìœ¼ë¡œ ë‚˜ì˜µë‹ˆë‹¤.

const messageLines = [];
// [!] ì œëª© ìˆ˜ì • ë° ì‹œê°„ ì¶”ê°€ (ê¸€ì í¬ê¸° ì¡°ì •)
messageLines.push(`<div class="quote-title">âœ… ê²¬ì ì…ë‹ˆë‹¤! <span style="font-size:0.65em; color:#888; font-weight:normal; margin-left:8px;">${timeString}</span></div>`);

let total = 0;

for (const item of mergedMap.values()) {
    const labelToShow = item.displayLabel ? ` ${item.displayLabel}` : '';

    messageLines.push(`<div class="item-title">ğŸ”¹ ${item.name}${labelToShow}</div>`);
    messageLines.push(`<div class="item-detail">ğŸ”¸ ìì¬ë¹„: ${item.material.toLocaleString()}ì›</div>`);
    messageLines.push(`<div class="item-detail">ğŸ”¸ ì¸ê±´ë¹„: ${item.labor.toLocaleString()}ì›</div>`);
    messageLines.push(`<div class="item-detail item-subtotal">ğŸ”¸ ì†Œê³„: ${item.subtotal.toLocaleString()}ì›</div>`);
    
    if (item.itemText?.trim()) {
        const notificationHtml = item.itemText.trim().replace(/\n/g, '<br>ğŸ“Œ ');
        messageLines.push(`<div class="item-notification">ğŸ“Œ ${notificationHtml}</div>`);
    }
    
    messageLines.push('<div class="item-spacer"></div>');
    total += item.subtotal;
}

messageLines.push(`<div class="total-line">ğŸ”¥ ì˜ˆìƒ ê²¬ì : ${total.toLocaleString()}ì›</div>`);
messageLines.push('<div class="common-title">ğŸ“Œ ê³µí†µ ìœ ì˜ì‚¬í•­</div>');
messageLines.push(`<div class="common-detail">${commonNotification}</div>`);

// (ì—°ë½ì²˜ ë°•ìŠ¤ëŠ” chat.htmlì—ì„œ ê·¸ë¦¬ê¸° ë•Œë¬¸ì— ì—¬ê¸°ì„œëŠ” ì œì™¸)
// ë§Œì•½ n8nì—ì„œ ì œì–´í•˜ê³  ì‹¶ìœ¼ì‹œë©´ ì—¬ê¸°ì— ì¶”ê°€í•˜ì‹œë©´ ë©ë‹ˆë‹¤.

const finalMessage = messageLines.join('');

return [{
    message: finalMessage
}];
