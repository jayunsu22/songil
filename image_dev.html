<!-- 
    [Updated: 2026-01-12 21:00:00 KST]
    ìˆ˜ì •ë‚´ìš©:
    1. [ê¸°ë¡ë³´ì¡´] localStorageë¥¼ í™œìš©í•˜ì—¬ ì±„íŒ… ê¸°ë¡ ì˜êµ¬ ì €ì¥ (ìƒˆë¡œê³ ì¹¨ ì‹œì—ë„ ìœ ì§€)
    2. [ì´ˆê¸°í™”] ìƒë‹¨ 'ìƒˆë¡œê³ ì¹¨' ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ ì±„íŒ… ê¸°ë¡ ì‚­ì œ ë° ë¦¬ì…‹
    3. [ìŠ¤í¬ë¡¤ê°œì„ ] ìƒˆ ê²¬ì  ë„ì°© ì‹œ í™”ë©´ì´ ë§¨ ì•„ë˜ë¡œ íŠ€ì§€ ì•Šê³ , ì‚¬ìš©ìê°€ ë³´ë‚¸ ìš”ì²­ ìœ„ì¹˜(ê²°ê³¼ë¬¼ ì‹œì‘ì )ë¥¼ ìœ ì§€í•˜ë„ë¡ ê°œì„ 
       - 'scrollIntoView' ë¡œì§ì„ ì‚¬ìš©ì ë©”ì‹œì§€ ê¸°ì¤€ìœ¼ë¡œ ë³€ê²½
-->
<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì´ë¯¸ì§€ê²¬ì  (ì‹¤ì „ëª¨ë“œ V2)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0;
            background-color: #f0f2f5;
            height: 100%;
            overflow: hidden;
            letter-spacing: -0.5px;
        }

        .chat-wrapper {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            height: 100dvh;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }

        .chat-header {
            background-color: #4A90E2;
            color: white;
            padding: 15px;
            text-align: center;
            flex-shrink: 0;
            z-index: 100;
            position: relative;
        }

        .chat-header h1 {
            margin: 0;
            font-size: 1.3em;
            font-weight: 700;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 20px;
            background-color: #f9fafc;
        }

        /* [New] í€µ ë©”ë‰´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ìŠ¤ìƒ·2 ë””ìì¸ ì ìš©) */
        .quick-reply-btn {
            background-color: #ffffff;
            border: 1px solid #4A90E2;
            color: #4A90E2;
            padding: 8px 14px;
            margin: 4px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            font-family: 'Noto Sans KR', sans-serif;
            transition: all 0.2s ease;
            display: inline-block;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .quick-reply-btn:hover {
            background-color: #e7f1ff;
            /* ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ì—°í•œ í•˜ëŠ˜ìƒ‰ ë°°ê²½ */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .chat-bubble {
            width: fit-content;
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 12px;
            line-height: 1.5;
            position: relative;
            font-size: 1.05em;
            word-break: break-word;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .chat-bubble.user {
            background-color: #4A90E2;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
            margin-left: auto;
        }

        .chat-bubble.bot {
            background-color: #ffffff;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            margin-right: auto;
            border: 1px solid #eee;
        }

        .chat-bubble.bot-loading-blue {
            background: #4A90E2;
            color: white;
            text-align: center;
            border-radius: 30px;
            animation: pulse 1.5s infinite;
            margin: 10px auto;
            display: table;
            min-width: 220px;
            border: 2px solid white;
            font-weight: 700;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }

            100% {
                transform: scale(1);
            }
        }

        /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
        .chat-input-area {
            background-color: #fff;
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .input-row {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .input-wrapper {
            position: relative;
            flex: 1;
            display: flex;
            align-items: center;
        }

        #userInput {
            width: 100%;
            padding: 14px;
            padding-right: 45px;
            border: 1px solid #ddd;
            border-radius: 30px;
            font-size: 1em;
            outline: none;
            background: #f8f9fa;
            box-sizing: border-box;
        }

        .camera-btn {
            position: absolute;
            right: 10px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
        }

        #sendButton {
            margin-left: 10px;
            padding: 14px 24px;
            background-color: #4A90E2;
            color: white;
            border: none;
            border-radius: 30px;
            font-weight: 700;
            cursor: pointer;
        }

        /* ë‹¤ì¤‘ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ìŠ¤íƒ€ì¼ */
        #preview-container {
            display: none;
            margin-bottom: 10px;
            text-align: left;
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 5px;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        #preview-container::-webkit-scrollbar {
            display: none;
        }

        .preview-item {
            position: relative;
            display: inline-block;
            margin-right: 10px;
            vertical-align: top;
        }

        .preview-img {
            height: 90px;
            width: 90px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #ddd;
            display: block;
        }

        .preview-number {
            position: absolute;
            top: 5px;
            left: 5px;
            background: #e53e3e;
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 12px;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .preview-close {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #333;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            z-index: 20;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>

<body>
    <div class="chat-wrapper">
        <div class="chat-header">
            <h1 id="header-title">ì´ë¯¸ì§€ê²¬ì  V2</h1>

            <!-- ê°€ë§¹ì  ì†Œì…œ ë§í¬ ì˜ì—­ (ê³µë°± ìœ ì§€, í•˜ë‹¨ ëª…í•¨ì— ì§‘ì¤‘) -->
            <div id="partner-links" style="margin-top: 10px;"></div>

            <button onclick="resetChat()"
                style="position:absolute; right:15px; top:15px; background:rgba(255,255,255,0.2); border:none; color:white; padding:5px 10px; border-radius:5px; cursor:pointer;">ğŸ”„ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <div class="chat-container" id="chatContainer"></div>

        <div class="chat-input-area">
            <div id="preview-container"></div>

            <div class="input-row">
                <div class="input-wrapper">
                    <input type="text" id="userInput" placeholder="ì‚¬ì§„(ì—¬ëŸ¬ì¥ ê°€ëŠ¥) ë˜ëŠ” ë‚´ìš© ì…ë ¥...">
                    <input type="file" id="imageInput" accept="image/*" multiple style="display:none;"
                        onchange="handleImageSelect(event)">
                    <button class="camera-btn" onclick="document.getElementById('imageInput').click()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z">
                            </path>
                            <circle cx="12" cy="13" r="4"></circle>
                        </svg>
                    </button>
                </div>
                <button id="sendButton">ì „ì†¡</button>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            estimateUrl: "https://primary-production-a6fa.up.railway.app/webhook/image-test", // ê²¬ì  ìš”ì²­ìš©
            partnerUrl: "https://primary-production-a6fa.up.railway.app/webhook/partner-info", // ê°€ë§¹ì  ì •ë³´ ì¡°íšŒìš©
            secretToken: "songil_secret_2025",
            managerName: "ê¹€ì •í—Œ ì‹¤ì¥" // ê¸°ë³¸ê°’
        };

        let currentPartner = null; // ê°€ë§¹ì  ì •ë³´ ì €ì¥ìš©
        let chatHistory = []; // ì±„íŒ… ê¸°ë¡ ë©”ëª¨ë¦¬ ì €ì¥

        // [New] URLì—ì„œ code íŒŒë¼ë¯¸í„° ì½ì–´ì„œ ê°€ë§¹ì  ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        async function loadPartnerInfo() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');

            if (!code) return;

            try {
                const res = await fetch(`${CONFIG.partnerUrl}?code=${code}`);
                const data = await res.json();

                if (data.success === "true") {
                    currentPartner = data; // ë°ì´í„° ì €ì¥

                    // 1. í—¤ë” í…ìŠ¤íŠ¸ ë³€ê²½
                    const pName = data.partner_name || '';
                    const titleText = pName ? `${pName} 1ë¶„ê²¬ì ` : '1ë¶„ê²¬ì ';
                    document.getElementById('header-title').textContent = titleText;

                    // ìƒë‹¨ ë§í¬ ì˜ì—­ì€ ì˜ë„ì ìœ¼ë¡œ ë¹„ì›€
                    document.getElementById('partner-links').innerHTML = '';
                }
            } catch (e) {
                console.error("ê°€ë§¹ì  ì •ë³´ ë¡œë”© ì‹¤íŒ¨:", e);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        loadPartnerInfo();

        // [New] ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (v2_chat_history)
        function loadChatHistory() {
            const saved = localStorage.getItem('v2_chat_history');
            if (saved) {
                try {
                    chatHistory = JSON.parse(saved);
                    // ê°„í˜¹ ë°°ì—´ì´ ì•„ë‹Œ ê²½ìš° (null ë“±) ì˜ˆì™¸ì²˜ë¦¬
                    if (!Array.isArray(chatHistory)) chatHistory = [];

                    chatHistory.forEach(item => {
                        addBubble(item.message, item.sender, item.isQuote, false); // false = ì €ì¥ ì•ˆ í•¨ (ì´ë¯¸ í–ˆìœ¼ë‹ˆ)
                    });
                    // ë§ˆì§€ë§‰ìœ¼ë¡œ ìŠ¤í¬ë¡¤ ì´ë™
                    setTimeout(() => { chatContainer.scrollTop = chatContainer.scrollHeight; }, 100);
                } catch (e) {
                    console.error("History parse error", e);
                }
            }
        }

        // [New] ì±„íŒ… ì´ˆê¸°í™” ë²„íŠ¼ ê¸°ëŠ¥
        function resetChat() {
            if (!confirm("ëª¨ë“  ëŒ€í™” ë‚´ìš©ì„ ì‚­ì œí•˜ê³  ìƒˆë¡œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            localStorage.removeItem('v2_chat_history');
            location.reload();
        }

        function getUUID() {
            let uuid = localStorage.getItem('user_id');
            if (!uuid) {
                uuid = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
                localStorage.setItem('user_id', uuid);
            }
            return uuid;
        }
        const currentUserId = getUUID();
        console.log("Current User ID:", currentUserId);

        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const previewContainer = document.getElementById('preview-container');

        let selectedImages = []; // { file, previewUrl }

        function scrollToBottom() { setTimeout(() => { chatContainer.scrollTop = chatContainer.scrollHeight; }, 50); }

        function handleImageSelect(event) {
            const files = Array.from(event.target.files);
            if (!files.length) return;

            const remainingSlots = 5 - selectedImages.length;
            if (remainingSlots <= 0) {
                alert("ìµœëŒ€ 5ì¥ê¹Œì§€ë§Œ ì „ì†¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                return;
            }

            const filesToAdd = files.slice(0, remainingSlots);

            filesToAdd.forEach(file => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    selectedImages.push({
                        file: file,
                        previewUrl: e.target.result
                    });
                    renderPreviews(); // UI ê°±ì‹ 
                };
                reader.readAsDataURL(file);
            });
            event.target.value = '';
        }

        function removeImage(index) {
            selectedImages.splice(index, 1);
            renderPreviews();
        }

        function renderPreviews() {
            previewContainer.innerHTML = '';
            if (selectedImages.length === 0) {
                previewContainer.style.display = 'none';
                return;
            }
            previewContainer.style.display = 'block';

            selectedImages.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'preview-item';
                div.innerHTML = `
                   <div class="preview-number">${index + 1}</div>
                   <img src="${item.previewUrl}" class="preview-img">
                   <button class="preview-close" onclick="removeImage(${index})">Ã—</button>
               `;
                previewContainer.appendChild(div);
            });
        }

        // [í•µì‹¬ ë¡œì§] ì´ë¯¸ì§€ë¥¼ ì„¸ë¡œ(1ì—´)ë¡œ ë³‘í•©í•˜ê³  ì›Œí„°ë§ˆí¬ í‘œì‹œ
        async function mergeImages(imageItems) {
            if (imageItems.length === 0) return null;

            return new Promise((resolve) => {
                const images = [];
                let loadedCount = 0;

                imageItems.forEach((item, idx) => {
                    const img = new Image();
                    img.crossOrigin = "Anonymous";
                    img.onload = () => {
                        images[idx] = img;
                        loadedCount++;
                        if (loadedCount === imageItems.length) {
                            processMerge(images);
                        }
                    };
                    img.src = item.previewUrl;
                });

                function processMerge(imgs) {
                    // ê³ ì • ë„ˆë¹„ (ëª¨ë°”ì¼ ìµœì í™”)
                    const cellW = 800;

                    // ê° ì´ë¯¸ì§€ì˜ ë¹„ìœ¨ ìœ ì§€ ë†’ì´ ê³„ì‚°
                    let totalHeight = 0;
                    const scaledHeights = imgs.map(img => {
                        const scale = cellW / img.width;
                        const h = img.height * scale;
                        totalHeight += h;
                        return h;
                    });

                    const canvas = document.createElement('canvas');
                    canvas.width = cellW;
                    canvas.height = totalHeight;
                    const ctx = canvas.getContext('2d');

                    // ë°°ê²½ í°ìƒ‰
                    ctx.fillStyle = "#ffffff";
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    let currentY = 0;
                    imgs.forEach((img, i) => {
                        const h = scaledHeights[i];

                        // ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° (ê½‰ ì±„ìš°ê¸°)
                        ctx.drawImage(img, 0, currentY, cellW, h);

                        // [ìˆ˜ì •] ë²ˆí˜¸í‘œ ê·¸ë¦¬ê¸°: ì´ë¯¸ì§€ ì™¼ìª½ ìƒë‹¨ ë‚´ë¶€ì— í¬ê³  ì§„í•˜ê²Œ
                        drawWatermark(ctx, i + 1, 0, currentY);

                        // êµ¬ë¶„ì„  (ë§ˆì§€ë§‰ ì´ë¯¸ì§€ ì œì™¸)
                        if (i < imgs.length - 1) {
                            ctx.beginPath();
                            ctx.moveTo(0, currentY + h);
                            ctx.lineTo(cellW, currentY + h);
                            ctx.strokeStyle = "#ffffff";
                            ctx.lineWidth = 4;
                            ctx.stroke();
                        }

                        currentY += h;
                    });

                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                }

                function drawWatermark(ctx, num, x, y) {
                    // ë²ˆí˜¸í‘œ í¬ê¸° (ì§€ë¦„ 80px)
                    const size = 80;
                    const padding = 20; // ì—¬ë°±
                    const circleX = x + padding + (size / 2);
                    const circleY = y + padding + (size / 2);

                    // ê·¸ë¦¼ì íš¨ê³¼ë¡œ ì„ ëª…ë„ UP
                    ctx.shadowColor = "rgba(0, 0, 0, 0.5)";
                    ctx.shadowBlur = 10;
                    ctx.shadowOffsetX = 2;
                    ctx.shadowOffsetY = 2;

                    ctx.beginPath();
                    ctx.arc(circleX, circleY, size / 2, 0, 2 * Math.PI);
                    ctx.fillStyle = "#e53e3e"; // ê°•ë ¬í•œ ë¹¨ê°„ìƒ‰
                    ctx.fill();

                    // í°ìƒ‰ í…Œë‘ë¦¬
                    ctx.lineWidth = 4;
                    ctx.strokeStyle = "white";
                    ctx.stroke();

                    // ê·¸ë¦¼ì ë„ê¸° (í…ìŠ¤íŠ¸ëŠ” ê¹”ë”í•˜ê²Œ)
                    ctx.shadowColor = "transparent";

                    // ìˆ«ì
                    ctx.fillStyle = "white";
                    ctx.font = "bold 50px Arial";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.fillText(num, circleX, circleY + 4);
                }
            });
        }

        // [New] save=true íŒŒë¼ë¯¸í„° ì¶”ê°€í•˜ì—¬ ê¸°ë¡ ì €ì¥ ì œì–´
        function addBubble(message, sender, isQuote = false, save = true) {
            const bubble = document.createElement('div');
            bubble.classList.add('chat-bubble', sender);

            let content = message;

            // [ì¶”ê°€] ì¤‘ë³µ ì„œëª… ì œê±° ë¡œì§
            if (sender === 'bot') {
                if (isQuote || content.includes('ê²¬ì ') || content.includes('ê¸ˆì•¡')) {
                    // [ì¤‘ìš”] ì‚¬ìš©ìê°€ ìš”ì²­í•œëŒ€ë¡œ "ë¬¸ì˜ :" ë’·ë¶€ë¶„ì€ n8nì´ ë³´ë‚´ëŠ” ê°€ì§œ ì„œëª…ì´ë¯€ë¡œ ì œê±°
                    // (ë‹¨, n8nì´ 'ë‹´ë‹¹ :' (íˆ¬ëª…ë¬¸ì í¬í•¨)ìœ¼ë¡œ ë³´ë‚¼ ë•ŒëŠ” ì´ê²Œ ì‘ë™ ì•ˆ í•  ìˆ˜ ìˆì§€ë§Œ, ì•ˆì „ì¥ì¹˜ë¡œ ìœ ì§€)
                    const safeSplit = content.split('ë¬¸ì˜ :')[0];
                    if (safeSplit && safeSplit.length < content.length) {
                        content = safeSplit;
                    }
                }
            }

            // ê²¬ì ì„œ ë‚´ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ ë³´ì •
            if (isQuote) {
                content = content.replace(/max-width:100%/g, 'width:100%; max-width:100%; border-radius:12px;');
            }

            // [í•µì‹¬] ê°€ë§¹ì  ëª…í•¨(Footer) ì¶”ê°€ ë¡œì§
            // n8n ë©”ì‹œì§€ ë‚´ì— 'ğŸ“'ë‚˜ 'ë‹´ë‹¹' ê°™ì€ í‚¤ì›Œë“œê°€ ì´ë¯¸ ìˆë‹¤ë©´ í”„ë¡ íŠ¸ì—ì„œ ëª…í•¨ì„ ë¶™ì´ì§€ ì•ŠìŒ.
            // (n8n ì½”ë“œê°€ ëª…í•¨ì„ í¬í•¨í•˜ë„ë¡ ìˆ˜ì •ë˜ì—ˆìœ¼ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” ê·¸ê²Œ ì‹¤íŒ¨í–ˆì„ ë•Œì˜ ë°±ì—… ì—­í• ë§Œ í•¨)
            const hasSignature = content.includes('ë‹´ë‹¹\u200B :') || content.includes('ë‹´ë‹¹ :') || content.includes('ğŸ“');
            if (!hasSignature && sender === 'bot' && (isQuote || content.includes('ê²¬ì ') || content.includes('ê¸ˆì•¡'))) {

                // ê°€ë§¹ì  ì •ë³´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ (ê¹€ì •í—Œ ì‹¤ì¥)
                const partnerData = currentPartner || {};
                const ceo = partnerData.ceo_name || 'ê¹€ì •í—Œ';
                const pos = partnerData.position || 'ì‹¤ì¥';
                const phone = partnerData.phone || '010-6657-1222';

                const blog = partnerData.blog_url || '';
                const insta = partnerData.insta_url || '';
                const kakao = partnerData.kakao_url || '';

                const footerHtml = `
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 2px dashed #eee; text-align: center;">
                        <div style="display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">
                            <span style="font-weight: bold; font-size: 1.0em; color: #333; margin-right: 5px;">
                                ë¬¸ì˜ : ${ceo} ${pos}
                            </span>
                            ${blog ? `<a href="${blog}" target="_blank" style="display:inline-block; padding:2px 6px; background:#03C75A; color:white; text-decoration:none; border-radius:4px; font-size:0.85em; font-weight:bold;">ë¸”</a>` : ''}
                            ${insta ? `<a href="${insta}" target="_blank" style="display:inline-block; padding:2px 6px; background:linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); color:white; text-decoration:none; border-radius:4px; font-size:0.85em; font-weight:bold;">ì¸</a>` : ''}
                            ${kakao ? `<a href="${kakao}" target="_blank" style="display:inline-block; padding:2px 6px; background:#FEE500; color:#3c1e1e; text-decoration:none; border-radius:4px; font-size:0.85em; font-weight:bold;">ì¹´</a>` : ''}
                        </div>
                        <a href="tel:${phone}" style="display: block; width: 100%; box-sizing: border-box; background: white; border: 2px solid #4A90E2; color: #4A90E2; text-decoration: none; font-weight: 800; font-size: 1.3em; padding: 12px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            ğŸ“ ${phone}
                        </a>
                        ${(!content.includes('ê²¬ì  ì œê³µì´ ë˜ì§€ ì•ŠëŠ”') && !content.includes('ê²¬ì ì„ ì‚°ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤')) ?
                        `<button onclick="shareQuote()" style="display: inline-block; background: #f1f3f5; color: #495057; border: none; padding: 8px 16px; border-radius: 20px; font-size: 0.9em; cursor: pointer;">
                            ğŸ”— ê²¬ì ë‚´ìš© ê³µìœ í•˜ê¸°
                        </button>` : ''}
                    </div>
                `;
                content += footerHtml;
            }

            bubble.innerHTML = isQuote ? `<div class="quote-content">${content}</div>` : content;
            chatContainer.appendChild(bubble);

            // [ì €ì¥] ìƒˆë¡œìš´ ë©”ì‹œì§€ë©´ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ (saveê°€ trueì¼ ë•Œë§Œ)
            if (save) {
                chatHistory.push({ message: content, sender: sender, isQuote: isQuote });
                localStorage.setItem('v2_chat_history', JSON.stringify(chatHistory));
            }

            return bubble;
        }

        function addTimerBubble(message) {
            const bubble = document.createElement('div');
            bubble.classList.add('chat-bubble', 'bot-loading-blue');
            bubble.innerHTML = `â³ ${message}`;
            chatContainer.appendChild(bubble);
            scrollToBottom();
            return bubble;
        }

        // ê³µìœ í•˜ê¸° ê¸°ëŠ¥ í•¨ìˆ˜
        function shareQuote() {
            if (navigator.share) {
                navigator.share({
                    title: 'ì´ë¯¸ì§€ ê²¬ì  ê²°ê³¼',
                    text: 'ê²¬ì  ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!',
                    url: window.location.href
                });
            } else {
                alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                navigator.clipboard.writeText(window.location.href);
            }
        }

        async function sendRequest() {
            const msg = userInput.value.trim();
            if (!msg && selectedImages.length === 0) return;

            // [New] ì¼ì¼ ë¬´ë£Œ ê²¬ì  3íšŒ ì œí•œ (ì´ë¯¸ì§€ í¬í•¨ ì‹œ)
            // ë‹¨, URL íŒŒë¼ë¯¸í„°ì— 'admin=true'ê°€ ìˆê±°ë‚˜, í•´ì‹œê°’ì— #adminì´ ìˆìœ¼ë©´ ì œí•œ ë¬´ì‹œ
            const isManager = window.location.href.includes('admin=true') || window.location.hash.includes('#admin');

            if (!isManager && selectedImages.length > 0) {
                const today = new Date().toISOString().split('T')[0];
                const key = 'daily_quote_v1';
                const stored = JSON.parse(localStorage.getItem(key)) || { date: today, count: 0 };
                const curCount = (stored.date === today) ? stored.count : 0;

                if (curCount >= 3) {
                    addBubble("ğŸš« <b>ì¼ì¼ ë¬´ë£Œ ê²¬ì  íšŸìˆ˜(3íšŒ) ì´ˆê³¼</b><br><br>ê³¼ë„í•œ AI ë¹„ìš© ë°œìƒ ë°©ì§€ë¥¼ ìœ„í•´ ì´ë¯¸ì§€ ê²¬ì ì€ í•˜ë£¨ 3íšŒë¡œ ì œí•œë©ë‹ˆë‹¤.<br>ë‚´ì¼ ë‹¤ì‹œ ì´ìš©í•´ ì£¼ì‹œê±°ë‚˜, í…ìŠ¤íŠ¸ë¡œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”! ğŸ™", 'bot');
                    return;
                }
            }

            let displayMsg = msg;

            // ì‚¬ìš©ìê°€ ë³´ëŠ” í™”ë©´ì—” ì²«ì¥ë§Œ í¬ê²Œ ë„ìš°ê³  ë’¤ì— +Nì¥ í‘œì‹œ
            if (selectedImages.length > 0) {
                const firstImg = selectedImages[0].previewUrl;
                let countBadge = selectedImages.length > 1 ? `<span style="background:rgba(0,0,0,0.6); color:white; position:absolute; bottom:5px; right:5px; padding:2px 8px; border-radius:10px; font-size:0.8em; font-weight:bold;">+${selectedImages.length - 1}</span>` : "";

                displayMsg = `<div style="position:relative; display:inline-block;">
                               <img src="${firstImg}" style="max-width:200px; max-height:200px; border-radius:8px; display:block; border:1px solid #ddd;">
                               ${countBadge}
                             </div>`;
                if (msg) displayMsg += `<div style="margin-top:8px;">${msg}</div>`;
            }

            // [ì¤‘ìš”] ì‚¬ìš©ìê°€ ë³´ë‚¸ ë§í’ì„  ìƒì„± ë° 'ìœ„ì¹˜ ì €ì¥'
            const userBubble = addBubble(displayMsg, 'user');

            // ì‚¬ìš©ìê°€ ë³´ë‚¸ ì§í›„ì—ëŠ” ì¼ë‹¨ ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤ (ë‚´ê°€ ì“´ ê±´ ë´ì•¼ í•˜ë‹ˆê¹Œ)
            scrollToBottom();

            userInput.value = "";
            const imagesToProcess = [...selectedImages];
            selectedImages = [];
            renderPreviews();
            sendButton.disabled = true;

            let sec = 0;
            const loading = addTimerBubble(`ê²¬ì  ê³„ì‚° ì¤‘...`);
            const timer = setInterval(() => {
                sec++;
                loading.innerHTML = `â³ ê²¬ì  ê³„ì‚° ì¤‘... ${sec}s`;
            }, 1000);

            try {
                let finalImage = null;
                if (imagesToProcess.length > 0) {
                    finalImage = await mergeImages(imagesToProcess);

                    // [New] ì¹´ìš´íŠ¸ ì°¨ê° (ì´ë¯¸ì§€ ë³€í™˜ ì„±ê³µ í›„)
                    const today = new Date().toISOString().split('T')[0];
                    const key = 'daily_quote_v1';
                    let stored = JSON.parse(localStorage.getItem(key)) || { date: today, count: 0 };
                    if (stored.date !== today) stored = { date: today, count: 0 };
                    stored.count++;
                    localStorage.setItem(key, JSON.stringify(stored));
                }

                // [ìˆ˜ì •] í˜„ì¬ ì ‘ì†í•œ ê°€ë§¹ì  ì½”ë“œ(code)ë¥¼ í•¨ê»˜ ì „ì†¡
                const urlParams = new URLSearchParams(window.location.search);
                const pCode = urlParams.get('code') || '';

                const payload = {
                    message: msg,
                    image: finalImage,
                    partner_code: pCode // n8nì—ì„œ ì´ ì½”ë“œë¡œ ì—…ì²´ë¥¼ ì‹ë³„í•©ë‹ˆë‹¤
                };

                const res = await fetch(CONFIG.estimateUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-secret-token': CONFIG.secretToken,
                        'x-user-id': currentUserId
                    },
                    body: JSON.stringify(payload)
                });

                clearInterval(timer);
                if (loading.parentNode) loading.parentNode.removeChild(loading);

                if (!res.ok) throw new Error('Server Error');
                const data = await res.json();

                if (Array.isArray(data) && data.length > 0 && data[0].output) {
                    addBubble(data[0].output, 'bot', true);
                } else if (data.output) {
                    addBubble(data.output, 'bot', true);
                } else if (Array.isArray(data) && data.length > 0 && data[0].message) {
                    addBubble(data[0].message, 'bot', true);
                } else if (data.message) {
                    addBubble(data.message, 'bot', true);
                } else {
                    addBubble("âœ… ê³„ì‚° ì™„ë£Œ! (ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”)", 'bot');
                }

                // [í•µì‹¬] ë´‡ ì‘ë‹µì´ ì˜¨ í›„, ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ê°€ ì•„ë‹Œ 'ì‚¬ìš©ìê°€ ë³´ë‚¸ ë©”ì‹œì§€' ìœ„ì¹˜ë¡œ ë¶€ë“œëŸ½ê²Œ ì´ë™
                // ì´ë ‡ê²Œ í•˜ë©´ ê²°ê³¼ë¬¼ì˜ ì‹œì‘ì ë¶€í„° ë³¼ ìˆ˜ ìˆìŒ
                // ì•½ê°„ì˜ ë”œë ˆì´ í›„ ì´ë™ (DOM ë Œë”ë§ ì‹œê°„ ê³ ë ¤)
                setTimeout(() => {
                    userBubble.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);

            } catch (e) {
                clearInterval(timer);
                if (loading.parentNode) loading.parentNode.removeChild(loading);
                console.error(e);
                addBubble("âš ï¸ ì„œë²„ ì—°ê²° ì‹¤íŒ¨. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", 'bot');
                scrollToBottom();
            } finally {
                sendButton.disabled = false;
            }
        }

        // [New] í€µ ë©”ë‰´(ë²„íŠ¼ì‹ ê²¬ì ) í‚¤ì›Œë“œ ì •ì˜
        const QUICK_KEYWORDS = [
            "30í‰ ì•„íŒŒíŠ¸ ì „ì²´", "40í‰ ë¹Œë¼ ì „ì²´", "ë°©ë¬¸3, í™”ì¥ì‹¤ë¬¸2",
            "í˜„ê´€ë¬¸1", "ë¬¸í‹€ 7ê°œ", "ë¬¸ì§ 3ê°œ", "ì¤‘ë¬¸ 1ê°œ",
            "í„°ë‹ë„ì–´ 2ê°œ", "ìƒ¤ì‹œ2", "ì‹œìŠ¤í…œìƒ¤ì‹œ3",
            "ì‹œìŠ¤í…œìƒ¤ì‹œ 2m 3ê°œ", "ìƒ¤ì‹œ2ì¤‘ì°½ 5m 3ê°œ", "ê°ˆë°” 5m",
            "ì‹¤ë¦¬ì½˜ì¬ì‹œê³µ 30m", "ì²œì¥ëª°ë”© 30í‰", "ëª°ë”© 20í‰",
            "ê±¸ë ˆë°›ì´ 30í‰", "ì‹±í¬ëŒ€ 2.4m", "ì‹±í¬ëŒ€í•˜ë¶€ì¥ 3m",
            "ë¶™ë°•ì´ì¥ 2ì„¸íŠ¸", "ìˆ˜ë‚©ì¥ ", "ì‹ ë°œì¥ 1ê°œ", "ë“±ë°•ìŠ¤ 10m",
            "ê°€ë²½ 10m", "ì•ŒíŒ 5m", "ì›¨ì¸ìŠ¤ì½”íŒ… 10m",
            "ì•„ì¹˜ê²Œì´íŠ¸ 2ê°œ", "ì•„íŠ¸ì›” 1ë©´", "ëƒ‰ì¥ê³ ì¥ 1ê°œ",
            "ì‹ ë°œì¥ë¬¸ì§ 2ê°œ"
        ];

        // í€µ ë©”ë‰´ ë²„íŠ¼ í‘œì‹œ í•¨ìˆ˜
        function showQuickButtons() {
            const container = document.createElement('div');
            container.className = 'quick-reply-container';
            container.style.cssText = "margin: 10px 0; padding: 10px; text-align: center;";

            QUICK_KEYWORDS.forEach(keyword => {
                const btn = document.createElement('button');
                btn.className = 'quick-reply-btn';
                btn.innerText = keyword;
                btn.onclick = () => {
                    // í…ìŠ¤íŠ¸ ì…ë ¥ì°½ì— ë„£ê³  ë°”ë¡œ ì „ì†¡
                    userInput.value = keyword;
                    sendRequest();
                };
                container.appendChild(btn);
            });

            // ì±„íŒ…ì°½ì— ì¶”ê°€
            chatContainer.appendChild(container);
            scrollToBottom();
        }

        sendButton.addEventListener('click', sendRequest);
        userInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendRequest(); });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ ê¸°ë¡ ë³µì› ë° í€µ ë²„íŠ¼ í‘œì‹œ
        loadChatHistory();

        // [New] ì´ˆê¸° ë¡œë”© ì™„ë£Œ í›„ í€µ ë²„íŠ¼ í‘œì‹œ (ì•½ê°„ì˜ ë”œë ˆì´ í›„)
        setTimeout(() => {
            // ì´ë¯¸ í€µ ë²„íŠ¼ì´ ìˆëŠ”ì§€ í™•ì¸ í›„ ì—†ìœ¼ë©´ ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
            if (!document.querySelector('.quick-reply-container')) {
                showQuickButtons();
            }
        }, 500);

    </script>
</body>

</html>
<!-- [Updated: 2026-01-12 21:00:00 KST] End -->
